# Output Artifacts

Understanding the files generated by the Compact compiler.

## Output Directory Structure

After compilation, the output directory contains:

```
build/
├── zkir/                        # Zero-knowledge intermediate representation
│   ├── transfer.zkir            # Circuit IR for 'transfer' circuit
│   ├── mint.zkir                # Circuit IR for 'mint' circuit
│   └── burn.zkir                # Circuit IR for 'burn' circuit
│
├── keys/
│   ├── prover/                  # Prover keys (client-side)
│   │   ├── transfer.pk          # Prover key for 'transfer'
│   │   ├── mint.pk              # Prover key for 'mint'
│   │   └── burn.pk              # Prover key for 'burn'
│   │
│   └── verifier/                # Verifier keys (on-chain)
│       ├── transfer.vk          # Verifier key for 'transfer'
│       ├── mint.vk              # Verifier key for 'mint'
│       └── burn.vk              # Verifier key for 'burn'
│
├── contract.ts                  # Generated TypeScript contract interface
├── witnesses.ts                 # Generated witness type definitions
├── types.ts                     # Generated type definitions
└── index.ts                     # Main export file
```

## ZKIR Files

**Zero-Knowledge Intermediate Representation** - compiled circuit logic.

### Purpose

- Intermediate format between Compact source and proving system
- Contains circuit constraints and logic
- Used by the prover to generate proofs

### File Format

```
build/zkir/circuit_name.zkir
```

One `.zkir` file per exported circuit in your contract.

### When Skipped

With `--skip-zk`, ZKIR files are still generated but keys are not:

```bash
compactc contract.compact -o build/ --skip-zk
# Creates: zkir/*.zkir
# Skips: keys/prover/*.pk, keys/verifier/*.vk
```

## Prover Keys

**Prover keys** are used client-side to generate zero-knowledge proofs.

### Purpose

- Enable proof generation for circuit execution
- Contain cryptographic parameters specific to each circuit
- Required when calling circuits that generate proofs

### Characteristics

| Property | Description |
|----------|-------------|
| Size | Large (MB to GB depending on circuit complexity) |
| Security | Can be distributed publicly |
| Location | Client-side (user's device or server) |

### File Format

```
build/keys/prover/circuit_name.pk
```

### Usage

```typescript
import { loadProverKey } from '@midnight-ntwrk/midnight-js-contracts';

const proverKey = await loadProverKey('build/keys/prover/transfer.pk');

// Proof generation uses the prover key internally
const result = await contract.callTx.transfer({ to, amount }, witnesses);
```

## Verifier Keys

**Verifier keys** are used on-chain to verify proofs.

### Purpose

- Enable verification of submitted proofs
- Deployed with contract to the blockchain
- Used by network validators to verify transactions

### Characteristics

| Property | Description |
|----------|-------------|
| Size | Small (KB) |
| Security | Must match prover keys exactly |
| Location | On-chain (part of deployed contract) |

### File Format

```
build/keys/verifier/circuit_name.vk
```

### Relationship to Prover Keys

```
Prover Key (pk) + Witness Data → Proof
Verifier Key (vk) + Proof + Public Inputs → Valid/Invalid
```

The prover and verifier keys are mathematically linked - a proof generated with a prover key can only be verified with its corresponding verifier key.

## TypeScript Generated Files

### contract.ts

Main contract interface with circuit call methods.

```typescript
// build/contract.ts (generated)

import { Contract, CircuitResult } from '@midnight-ntwrk/midnight-js-types';

export interface TokenContract {
  // Circuit call methods
  callTx: {
    transfer(
      args: { to: Uint8Array; amount: bigint },
      witnesses: Witnesses
    ): Promise<CircuitResult>;

    mint(
      args: { amount: bigint },
      witnesses: Witnesses
    ): Promise<CircuitResult>;

    burn(
      args: { amount: bigint },
      witnesses: Witnesses
    ): Promise<CircuitResult>;
  };

  // Ledger state accessors
  state: {
    balances: {
      get(key: Uint8Array): Promise<bigint | undefined>;
      has(key: Uint8Array): Promise<boolean>;
    };
    total_supply(): Promise<bigint>;
  };
}

export function createTokenContract(
  provider: MidnightProvider,
  address: string
): TokenContract;
```

### witnesses.ts

Type definitions for witness functions.

```typescript
// build/witnesses.ts (generated)

import { WitnessContext } from '@midnight-ntwrk/midnight-js-types';

export interface PrivateState {
  secretKey: Uint8Array;
  nonce: bigint;
}

export interface Witnesses {
  get_secret_key: (ctx: WitnessContext<PrivateState>) => Uint8Array;
  get_nonce: (ctx: WitnessContext<PrivateState>) => bigint;
  get_balance: (ctx: WitnessContext<PrivateState>) => bigint;
}
```

### types.ts

Compact types mapped to TypeScript.

```typescript
// build/types.ts (generated)

// Struct types
export interface User {
  id: Uint8Array;           // Bytes<32>
  balance: bigint;          // Uint<64>
  status: UserStatus;       // enum
}

// Enum types
export type UserStatus =
  | { tag: 'Active' }
  | { tag: 'Suspended' }
  | { tag: 'Closed' };

// Vector types
export type Votes = bigint[];  // Vector<Uint<64>, 10>
```

### index.ts

Re-exports everything for convenient importing.

```typescript
// build/index.ts (generated)

export * from './contract';
export * from './witnesses';
export * from './types';

// Contract module for deployment
export { TokenContractModule } from './contract';
```

## File Size Reference

Typical file sizes for a medium-complexity contract:

| Artifact | Typical Size | Notes |
|----------|--------------|-------|
| `.zkir` | 10KB - 1MB | Scales with circuit complexity |
| `.pk` (prover key) | 10MB - 500MB | Larger circuits = larger keys |
| `.vk` (verifier key) | 1KB - 50KB | Much smaller than prover keys |
| `.ts` (TypeScript) | 1KB - 20KB | Depends on interface size |

## Development vs Production

### Development Mode (`--skip-zk`)

```
build/
├── zkir/                 # Generated
│   └── *.zkir
├── keys/                 # EMPTY - skipped
├── contract.ts           # Generated
├── witnesses.ts          # Generated
└── index.ts              # Generated
```

Use for:
- Fast iteration
- TypeScript development
- Unit testing (mocked proofs)

### Production Mode (full build)

```
build/
├── zkir/                 # Generated
│   └── *.zkir
├── keys/
│   ├── prover/*.pk       # Generated - REQUIRED for deployment
│   └── verifier/*.vk     # Generated - REQUIRED for deployment
├── contract.ts           # Generated
├── witnesses.ts          # Generated
└── index.ts              # Generated
```

Use for:
- Integration testing with real proofs
- Testnet deployment
- Mainnet deployment

## Loading Artifacts in TypeScript

### Import Generated Types

```typescript
import {
  TokenContract,
  createTokenContract,
  Witnesses,
  PrivateState
} from './build';
```

### Load Contract Module

```typescript
import { TokenContractModule } from './build';
import { deployContract } from '@midnight-ntwrk/midnight-js-contracts';

const deployment = await deployContract(provider, {
  contractModule: TokenContractModule,
  // ...
});
```

### Access Keys Programmatically

```typescript
import { readFileSync } from 'fs';
import { join } from 'path';

const buildDir = './build';

// Load verifier key (for verification)
const verifierKey = readFileSync(
  join(buildDir, 'keys/verifier/transfer.vk')
);

// Prover keys are typically loaded automatically by the SDK
// when calling circuits
```

## Caching and Rebuilds

### When to Rebuild

| Change | Rebuild Needed |
|--------|----------------|
| Compact source modified | Yes |
| TypeScript source modified | No |
| Witness implementation changed | No |
| Circuit signature changed | Yes |
| Dependencies updated | Possibly |

### Incremental Builds

The compiler caches intermediate results:

```bash
# First build - full compilation
compactc contract.compact -o build/

# Second build - faster if no changes
compactc contract.compact -o build/
```

### Clean Build

Force full recompilation:

```bash
rm -rf build/
compactc contract.compact -o build/
```

## Security Considerations

### What to Commit to Version Control

| Artifact | Commit? | Reason |
|----------|---------|--------|
| Compact source | Yes | Source code |
| Generated TypeScript | Optional | Can regenerate |
| ZKIR files | No | Can regenerate |
| Prover keys | No | Large, can regenerate |
| Verifier keys | No | Can regenerate |

### Recommended .gitignore

```gitignore
# Build output
build/

# Or if you want to commit TypeScript:
build/zkir/
build/keys/
```

### Key Security

- Prover keys don't contain secrets - safe to distribute
- Verifier keys must match prover keys - tampering breaks verification
- Never commit private keys or wallet credentials
